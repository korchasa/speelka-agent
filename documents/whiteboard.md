# Architectural Decision Record: Централизация бизнес-логики конфигурации в types.Configuration

## Goal
Обеспечить чистое разделение ответственности: менеджер конфигурации (`internal/configuration/manager.go`) занимается только загрузкой и формированием итоговой конфигурации, а вся бизнес-логика, доступ к параметрам и валидация реализованы через структуру `internal/types/configuration.go`. После загрузки приложение работает только с экземпляром `types.Configuration`.

## Overview
- Сейчас: `manager.go` не только агрегирует конфигурацию из разных источников (defaults, файл, env), но и предоставляет бизнес-специфичные геттеры (`GetMCPServerConfig`, `GetLLMConfig` и т.д.), а также вызывает валидацию, что дублирует структуру и методы `types.Configuration` и усложняет сопровождение.
- Вся бизнес-логика доступа к параметрам, overlay, redaction и валидация уже реализованы в `types.Configuration`.
- Все тесты и лоадеры используют именно `types.Configuration` как основной формат.
- Вся остальная архитектура (agent, app, server) может работать только с этой структурой, не завися от менеджера.

### Плюсы текущего подхода
- Гибкая загрузка из разных источников.
- Централизованная валидация и overlay.

### Минусы текущего подхода
- Дублирование бизнес-логики доступа к параметрам и валидации в manager.go.
- Сложность поддержки: любые изменения структуры требуют синхронизации геттеров и логики валидации.
- Нарушение SRP: manager занимается не только загрузкой, но и бизнес-логикой.

## Definition of Done
- Менеджер конфигурации (`manager.go`) реализует только:
  - Загрузку и overlay конфигурации из defaults, файла, env.
  - Возвращает итоговый экземпляр `*types.Configuration`.
- Вся остальная часть приложения работает только с `*types.Configuration`.
- Нет бизнес-специфичных геттеров и валидации в manager.go.
- Валидация вызывается только через методы структуры `types.Configuration`.
- Все тесты проходят (`./run test`).
- Проверка линтера и сборки (`./run check`).

## Solution
1. Удалить все методы-геттеры из manager.go (`GetMCPServerConfig`, `GetLLMConfig`, и т.д.).
2. Оставить только методы загрузки и overlay.
3. Удалить вызов валидации из manager.go, перенести ответственность за валидацию в структуру `types.Configuration`.
4. Везде, где требуется доступ к параметрам или валидация, использовать напрямую поля и методы структуры `types.Configuration`.
5. Реализовать функции-конвертеры из `*types.Configuration` в `AgentConfig`, `LLMConfig`, `MCPServerConfig`, `MCPConnectorConfig` (например, `ToAgentConfig()`, `ToLLMConfig()` и т.д.) в internal/types/configuration.go.
6. В util.go и других местах получать types.Configuration через configManager.GetConfiguration() и вызывать соответствующий конвертер.
7. Обновить все вызовы в util.go и других местах.
8. Обновить тесты и app-слой для работы с новым контрактом.
9. Обновить документацию (implementation.md, architecture.md) по итогам изменений.

## Consequences
- + Упрощение кода, меньше дублирования.
- + Единая точка правды для структуры конфигурации и валидации.
- + Легче поддерживать и расширять конфиг.
- + Прозрачная работа overlay, redaction и валидации.
- + Легче тестировать (все тесты уже используют types.Configuration).
- - Потребуется обновить app-слой и тесты на новый контракт.
- - Возможна временная потеря обратной совместимости для внешних вызовов manager.go (если кто-то использует геттеры или валидацию напрямую).

## Critique & Refinement
- Решение полностью соответствует SRP и архитектурным принципам проекта.
- Все overlay, redaction, валидация уже реализованы в types.Configuration.
- Вся логика загрузки и overlay остается в manager.go, бизнес-логика доступа и валидация — только в types.Configuration.
- Все преобразования в бизнес-структуры централизованы в types.Configuration через функции-конвертеры.
- Нет рисков для безопасности или тестируемости.

## DoD: Project checks
- [x] Все тесты проходят (`./run test`)
- [x] Проверка линтера и сборки (`./run check`)
- [x] Property-based overlay тесты реализованы
- [x] Golden-тесты обратной совместимости реализованы
- [x] Документация обновлена (architecture.md, implementation.md)
