# Улучшение 4: Управление параллелизмом
## Статус
Новый

## Текущая проблема
Ограниченное использование возможностей параллелизма Go, с потенциалом для лучшей параллельной обработки.

## Улучшение
- Реализовать пулы рабочих процессов для выполнения инструментов для контроля параллелизма
- Использовать context и отмену корректно для обработки таймаутов
- Реализовать механизмы противодавления для обработки ситуаций перегрузки
- Добавить прерыватели цепи для внешних сервисов для предотвращения каскадных сбоев

## План реализации

### 1. Создать пул рабочих процессов для выполнения инструментов:
**Описание**: Создание пакета `concurrency` с интерфейсом `Job` и структурой `WorkerPool`.
Пул рабочих процессов будет управлять группой горутин, выполняющих задачи параллельно.
Ключевые компоненты:
- Интерфейс Job с методами Execute и ID
- Структура Result для результатов выполнения задач
- Структура WorkerPool для управления рабочими процессами
- Механизмы для запуска, отправки задач и корректного завершения работы пула
- Обработка контекста и таймаутов
- Противодавление при переполнении очереди задач

### 2. Модифицировать MCPConnector для использования пула рабочих процессов:
**Описание**: Создание структуры `ToolExecutionJob` и изменение `MCPConnector` для работы с пулом.
Реализация будет включать:
- Создание структуры задачи ToolExecutionJob для выполнения вызовов инструментов
- Методы для инициализации и управления пулом рабочих процессов в MCPConnector
- Адаптация ExecuteTool для отправки задач в пул и ожидания результатов
- Обработка ошибок и таймаутов при выполнении задач

### 3. Реализовать прерыватель цепи для внешних сервисов:
**Описание**: Создание пакета `circuit` с реализацией паттерна "прерыватель цепи".
Основные компоненты:
- Определение состояний прерывателя (закрыт, открыт, полуоткрыт)
- Механизмы подсчета неудач и успехов
- Автоматическое переключение между состояниями
- Контроль доступа к защищаемому сервису
- Функции для регистрации успехов/неудач и сброса состояния

### 4. Использовать прерыватель цепи для вызовов сервиса LLM:
**Описание**: Интеграция прерывателя цепи в сервис LLM для защиты от каскадных сбоев.
Реализация включает:
- Создание экземпляра прерывателя при инициализации сервиса LLM
- Проверка состояния прерывателя перед отправкой запросов
- Регистрация успешных и неудачных запросов
- Возврат соответствующих ошибок при открытом прерывателе
- Интеграция с системой повторных попыток

### 5. Реализовать таймауты и отмену везде:
**Описание**: Добавление корректной обработки таймаутов и отмены во всех частях приложения.
Ключевые аспекты:
- Создание контекстов с таймаутами для всех длительных операций
- Правильное каскадирование отмены контекста
- Структурированная обработка ошибок таймаута
- Корректная очистка ресурсов при отмене
- Разделение временных ограничений для разных типов операций

## Преимущества

1. **Эффективное использование ресурсов**: Пулы рабочих процессов предотвращают чрезмерное создание горутин
2. **Контролируемый параллелизм**: Предотвращает перегрузку внешних сервисов слишком большим количеством запросов
3. **Плавная деградация**: Прерыватели цепи предотвращают каскадные сбои
4. **Улучшенная отзывчивость**: Обработка таймаутов обеспечивает сохранение отзывчивости приложения
5. **Эффективное противодавление**: Предотвращает перегрузку системы при всплесках трафика
6. **Повышенная надежность**: Система автоматически восстанавливается после временных сбоев
7. **Лучшее распределение ресурсов**: Контроль над количеством параллельных операций