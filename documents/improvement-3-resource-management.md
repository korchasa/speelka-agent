# Улучшение 3: Корректное завершение работы и управление ресурсами

## Статус
Новый

## Текущая проблема
Некоторые ресурсы могут быть не освобождены должным образом при завершении работы, и отсутствует единый подход к управлению жизненным циклом ресурсов.

## Улучшение
- Реализовать унифицированную систему управления жизненным циклом ресурсов
- Добавить корректное распространение контекста по всему приложению
- Создать процедуру корректного завершения работы, гарантирующую освобождение ресурсов всеми компонентами в правильном порядке
- Добавить проверки работоспособности и индикаторы готовности

## План реализации

### 1. Определить интерфейс управления ресурсами:
**Файл: internal/types/lifecycle.go**

Описание: Создать пакет types с интерфейсом Lifecycle, который определяет методы для управления жизненным циклом компонентов:
- Name() - возвращает имя компонента
- Start(ctx) - инициализирует и запускает компонент
- Stop(ctx) - корректно останавливает компонент
- Health(ctx) - проверяет работоспособность компонента

Также определить структуру HealthStatus для представления состояния здоровья компонента и перечисление Status с возможными значениями: ok, warning, error, starting, stopping, stopped.

### 2. Реализовать интерфейс для каждого компонента:
**Файл: internal/mcp_connector/mcp_connector.go**

Описание: Реализовать методы интерфейса Lifecycle для компонента MCPConnector:
- Name() - возвращает "MCPConnector"
- Start(ctx) - инициализирует ресурсы, подключается к MCP серверам
- Stop(ctx) - закрывает все соединения параллельно с таймаутом, обрабатывает ошибки
- Health(ctx) - проверяет статус всех соединений с MCP серверами, формирует детальный отчет

### 3. Создать менеджер жизненного цикла:
**Файл: internal/lifecycle/manager.go**

Описание: Реализовать структуру Manager, отвечающую за управление жизненным циклом компонентов приложения:
- Register(component, startOrderIdx) - регистрирует компонент с указанием порядка запуска
- Start(ctx) - запускает все компоненты в порядке регистрации
- Stop(ctx) - останавливает все компоненты в обратном порядке
- Health(ctx, forceRefresh) - возвращает статус здоровья всех компонентов

Менеджер содержит список компонентов, кэш состояний здоровья и механизмы для корректной очередности запуска/остановки.

### 4. Реализовать корректное завершение работы в главном модуле:
**Файл: cmd/server/main.go**

Описание: Модифицировать функцию main() для обработки сигналов завершения и корректной остановки всех компонентов:
- Настроить обработку сигналов SIGINT и SIGTERM
- Создать базовый контекст для приложения
- Инициализировать компоненты и зарегистрировать их в менеджере жизненного цикла
- Запустить компоненты через менеджер жизненного цикла
- При получении сигнала завершения, создать контекст с таймаутом и вызвать остановку через менеджер
- Логировать процесс остановки и любые ошибки

### 5. Добавить эндпоинт для проверки состояния компонентов:
**Файл: internal/mcp_server/health.go**

Описание: Добавить HTTP обработчики для проверки работоспособности:
- /health - возвращает подробный статус всех компонентов в формате JSON
- /ready - возвращает 200 OK, если все компоненты работают нормально, или 503 Service Unavailable в противном случае

Эндпоинт health предоставляет общий статус ("ok", "warning", "error") и детальную информацию о каждом компоненте, включая описание проблемы в случае сбоев.

## Преимущества

1. **Предсказуемый запуск и остановка**: Компоненты запускаются и останавливаются в правильном порядке
2. **Освобождение ресурсов**: Все ресурсы правильно освобождаются при завершении работы
3. **Корректное завершение**: Компоненты имеют время для завершения текущих операций
4. **Мониторинг работоспособности**: Системное здоровье можно отслеживать через эндпоинты здоровья
5. **Готовность контейнера**: Платформы оркестрации контейнеров могут определять, когда сервис готов
6. **Предотвращение утечек**: Предотвращает утечки ресурсов и улучшает стабильность в долгосрочной перспективе
7. **Изоляция ошибок**: Проблемы в одном компоненте не влияют на корректное завершение других